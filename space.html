<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Space P2P Chat â€” Single HTML</title>
<style>
  :root{
    --glass: rgba(255,255,255,0.08);
    --border: rgba(255,255,255,0.22);
    --neon:#7df9ff; --neon2:#9c6bff;
    --text:#e8f1ff; --muted:#a9b3c7;
  }
  html,body{height:100%;margin:0;background:#020617;color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial}
  canvas#stars{position:fixed;inset:0;z-index:-2}
  .halo{position:fixed;left:50%;top:45%;transform:translate(-50%,-50%);
    width:62vmin;height:62vmin;border-radius:50%;
    box-shadow:0 0 140px 40px rgba(125,249,255,.16), inset 0 0 260px 70px rgba(156,107,255,.12);
    filter:blur(2px);z-index:-1}
  .wrap{max-width:1000px;margin:6vh auto;padding:20px;display:grid;gap:18px;
    grid-template-columns:360px 1fr}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  .panel{backdrop-filter: blur(12px) saturate(120%);
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
    border:1px solid var(--border);border-radius:16px;padding:16px;
    box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04)}
  .panel h2{margin:4px 0 10px}
  .hint{color:var(--muted);font-size:13px}
  textarea,input[type=text]{width:100%;border-radius:12px;border:1px solid var(--border);
    background:var(--glass);color:var(--text);outline:none}
  textarea{min-height:120px;padding:10px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);
    background:linear-gradient(180deg,#1b2333,#151b28);color:var(--text);cursor:pointer;
    font-weight:600;transition:transform .06s, box-shadow .2s}
  button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(125,249,255,.15)}
  button.primary{border-color:rgba(125,249,255,.4);box-shadow:inset 0 0 18px rgba(125,249,255,.14)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
    background:var(--glass);font-size:12px}
  .statusRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%;box-shadow:0 0 16px currentColor}
  .chat{height:62vh;min-height:360px;display:flex;flex-direction:column}
  .log{flex:1;overflow:auto;padding:12px;border-radius:12px;border:1px dashed rgba(255,255,255,.18);
    background:linear-gradient(180deg, rgba(0,10,24,.45), rgba(10,8,28,.45))}
  .msg{display:flex;gap:10px;margin:8px 0;align-items:flex-end}
  .msg.me{flex-direction:row-reverse}
  .bubble{max-width:68%;padding:10px 12px;border-radius:12px;
    background:rgba(125,249,255,.09);border:1px solid rgba(125,249,255,.25);
    box-shadow:0 6px 20px rgba(125,249,255,.12);white-space:pre-wrap;word-wrap:break-word}
  .msg.me .bubble{background:rgba(156,107,255,.10);border-color:rgba(156,107,255,.35);
    box-shadow:0 6px 20px rgba(156,107,255,.16)}
  .meta{font-size:11px;color:var(--muted);margin:0 6px}
  .inputRow{display:flex;gap:8px;margin-top:10px}
  .foot{text-align:center;color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
<canvas id="stars"></canvas>
<div class="halo"></div>

<div class="wrap">
  <section class="panel">
    <h2>ğŸ›°ï¸ æ‰‹å‹•ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼ˆã‚³ãƒ”ãƒšæ–¹å¼ï¼‰</h2>
    <div class="row statusRow">
      <span class="badge" id="role">role: -</span>
      <span class="badge" id="state">rtc: -</span>
      <span title="WebRTC" class="dot" id="rtcDot" style="color:#888"></span>
      <span title="DataChannel" class="dot" id="dcDot" style="color:#888"></span>
    </div>
    <p class="hint">
      1) ã©ã¡ã‚‰ã‹ãŒã€Œã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç”Ÿæˆã€â†’å‡ºåŠ›ã‚’ç›¸æ‰‹ã¸ã€‚<br>
      2) å—ã‘å–ã£ãŸå´ã¯ã€Œç›¸æ‰‹ã®SDPã€ã«è²¼ã£ã¦ã€Œã‚¢ãƒ³ã‚µãƒ¼ã‚’ç”Ÿæˆã€â†’è¿”é€ã€‚<br>
      3) æœ€åˆã®äººã¯ã€Œç›¸æ‰‹ã®SDPã€ã«ã‚¢ãƒ³ã‚µãƒ¼ã‚’è²¼ã£ã¦ã€Œã‚¢ãƒ³ã‚µãƒ¼ã‚’é©ç”¨ã€ã€‚<br>
      ï¼ˆICE å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã®ã§ã€å€™è£œã®ã‚³ãƒ”ãƒšã¯ä¸è¦ã§ã™ï¼‰
    </p>

    <div class="row">
      <button class="primary" id="btnMakeOffer">â‘  ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç”Ÿæˆ</button>
      <button id="btnApplyAnswer">â‘¢ ã‚¢ãƒ³ã‚µãƒ¼ã‚’é©ç”¨</button>
    </div>

    <div class="row">
      <button id="btnMakeAnswer">â‘¡ ã‚¢ãƒ³ã‚µãƒ¼ã‚’ç”Ÿæˆ</button>
      <button id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <label class="hint">ç›¸æ‰‹ã®SDPï¼ˆã‚‚ã‚‰ã£ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚‹ï¼‰</label>
    <textarea id="remoteSdp" placeholder="ã“ã“ã«ç›¸æ‰‹ã® SDP ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã§ç”Ÿæˆã•ã‚ŒãŸ Base64 æ–‡å­—åˆ—ï¼‰ã‚’è²¼ã‚‹"></textarea>

    <label class="hint">ã‚ãªãŸã®SDPï¼ˆç›¸æ‰‹ã«é€ã‚‹ç”¨ãƒ»è‡ªå‹•ç”Ÿæˆï¼‰</label>
    <textarea id="localSdp" readonly placeholder="ã“ã“ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’ç›¸æ‰‹ã«æ¸¡ã—ã¦ãã ã•ã„ã€‚"></textarea>
  </section>

  <section class="panel chat">
    <h2>ğŸŒŒ Space Chat (P2P)</h2>
    <div id="log" class="log" aria-live="polite"></div>
    <div class="inputRow">
      <textarea id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦ï¼ˆEnteré€ä¿¡ / Shift+Enteræ”¹è¡Œï¼‰"></textarea>
      <button class="primary" id="send">é€ä¿¡ âŸ¶</button>
    </div>
    <div class="foot">Single-file WebRTC DataChannel Chat Â© You</div>
  </section>
</div>

<script>
/* ==== æ˜Ÿç©ºèƒŒæ™¯ ==== */
(function(){
  const c = document.getElementById('stars'), ctx = c.getContext('2d');
  let w,h,stars=[];
  function resize(){ w=c.width=innerWidth; h=c.height=innerHeight;
    const n = Math.min(420, Math.floor((w*h)/6000));
    stars = Array.from({length:n}, ()=>({x:Math.random()*w,y:Math.random()*h,z:Math.random()+.2,s:Math.random()*1.6+.2}));
  }
  function tick(){ ctx.clearRect(0,0,w,h); ctx.fillStyle='#fff';
    for(const s of stars){ s.x+=s.z*.6; s.y+=s.z*.15; if(s.x>w||s.y>h){ s.x=Math.random()*w*0.2; s.y=-10 }
      ctx.globalAlpha=s.z*.9; ctx.fillRect(s.x,s.y,s.s,s.s);
    } requestAnimationFrame(tick);
  }
  addEventListener('resize', resize); resize(); tick();
})();

/* ==== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==== */
const $ = q => document.querySelector(q);
const logEl = $('#log');
function addMsg(text, me=false){
  const wrap = document.createElement('div'); wrap.className='msg'+(me?' me':'');
  const bubble = document.createElement('div'); bubble.className='bubble'; bubble.textContent = text;
  const meta = document.createElement('div'); meta.className='meta'; meta.textContent = new Date().toLocaleTimeString();
  wrap.appendChild(bubble); wrap.appendChild(meta); logEl.appendChild(wrap);
  logEl.scrollTop = logEl.scrollHeight;
}
function setBadge(id, text){ document.getElementById(id).textContent = text; }
function b64encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
function b64decode(str){ return JSON.parse(decodeURIComponent(escape(atob(str)))); }

/* ==== WebRTCï¼ˆæ‰‹å‹•ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼‰ ==== */
let pc=null, dc=null, role='-';
const iceConfig = { iceServers:[ {urls:'stun:stun.l.google.com:19302'}, {urls:'stun:global.stun.twilio.com:3478?transport=udp'} ] };

function updateStates(){
  if(!pc) { $('#rtcDot').style.color='#888'; setBadge('state','rtc: -'); return; }
  const st = pc.iceConnectionState;
  $('#rtcDot').style.color = (st==='connected'||st==='completed')? '#6bffb0' : (st==='failed'? '#ff6b9c' : '#ffc66b');
  setBadge('state','rtc: '+st);
}
function bindDC(){
  dc.onopen = ()=>{ $('#dcDot').style.color='#6bffb0'; addMsg('âœ… DataChannel open'); };
  dc.onclose= ()=>{ $('#dcDot').style.color='#888'; addMsg('âŒ DataChannel closed'); };
  dc.onmessage = e => addMsg(e.data, false);
}

function resetAll(){
  if(dc){ try{dc.close()}catch{} dc=null; }
  if(pc){ try{pc.close()}catch{} pc=null; }
  role='-'; setBadge('role','role: -'); updateStates();
  $('#localSdp').value=''; $('#remoteSdp').value='';
  addMsg('ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

function createPC(){
  pc = new RTCPeerConnection(iceConfig);
  pc.oniceconnectionstatechange = updateStates;
  pc.onicegatheringstatechange = ()=>{}; // no-op
  pc.ondatachannel = e => { dc = e.channel; bindDC(); };
}

function waitIceComplete(){
  return new Promise(res=>{
    if(pc.iceGatheringState==='complete') return res();
    function check(){
      if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', check); res(); }
    }
    pc.addEventListener('icegatheringstatechange', check);
  });
}

/* --- â‘  ã‚ªãƒ•ã‚¡ãƒ¼ç”Ÿæˆï¼ˆå…ˆã«æ“ä½œã™ã‚‹å´ï¼‰ --- */
$('#btnMakeOffer').addEventListener('click', async ()=>{
  resetAll(); createPC(); role='offerer'; setBadge('role','role: offerer');
  dc = pc.createDataChannel('chat',{ordered:true}); bindDC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  // ICE ãŒå‡ºæƒã†ã¾ã§å¾…ã£ã¦ã‹ã‚‰ SDP ã‚’å‡ºåŠ›ï¼ˆéãƒˆãƒªã‚¯ãƒ«ï¼‰
  await waitIceComplete();
  $('#localSdp').value = b64encode(pc.localDescription);
  addMsg('ğŸ› ï¸ ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚ä¸Šã®ã€Œã‚ãªãŸã®SDPã€ã‚’ç›¸æ‰‹ã¸é€ã£ã¦ãã ã•ã„ã€‚');
});

/* --- â‘¡ ã‚¢ãƒ³ã‚µãƒ¼ç”Ÿæˆï¼ˆå¾Œã‹ã‚‰æ“ä½œã™ã‚‹å´ï¼‰ --- */
$('#btnMakeAnswer').addEventListener('click', async ()=>{
  if(pc){ try{pc.close()}catch{} }
  createPC(); role='answerer'; setBadge('role','role: answerer');
  const remoteText = $('#remoteSdp').value.trim();
  if(!remoteText){ addMsg('âš ï¸ ç›¸æ‰‹ã®SDPã‚’è²¼ã£ã¦ãã ã•ã„'); return; }
  try{
    const remote = b64decode(remoteText);
    await pc.setRemoteDescription(remote);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitIceComplete();
    $('#localSdp').value = b64encode(pc.localDescription);
    addMsg('ğŸ§© ã‚¢ãƒ³ã‚µãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚ã“ã®ã€Œã‚ãªãŸã®SDPã€ã‚’ç›¸æ‰‹ã«è¿”ã—ã¦ãã ã•ã„ã€‚');
  }catch(e){ console.error(e); addMsg('âŒ SDP ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
});

/* --- â‘¢ ã‚ªãƒ•ã‚¡ãƒ¼å´ï¼šã‚¢ãƒ³ã‚µãƒ¼é©ç”¨ --- */
$('#btnApplyAnswer').addEventListener('click', async ()=>{
  if(!pc){ addMsg('âš ï¸ ã¾ãšã€Œâ‘  ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç”Ÿæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
  const remoteText = $('#remoteSdp').value.trim();
  if(!remoteText){ addMsg('âš ï¸ ç›¸æ‰‹ã®SDPï¼ˆã‚¢ãƒ³ã‚µãƒ¼ï¼‰ã‚’è²¼ã£ã¦ãã ã•ã„'); return; }
  try{
    const remote = b64decode(remoteText);
    await pc.setRemoteDescription(remote);
    addMsg('ğŸ”— ã‚¢ãƒ³ã‚µãƒ¼ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºç«‹ä¸­â€¦');
  }catch(e){ console.error(e); addMsg('âŒ ã‚¢ãƒ³ã‚µãƒ¼ã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
});

/* --- ãƒãƒ£ãƒƒãƒˆé€å—ä¿¡ --- */
function sendText(){
  const t = $('#text'); const v = t.value;
  if(!v.trim()) return;
  if(!dc || dc.readyState!=='open'){ addMsg('âš ï¸ ã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  dc.send(v); addMsg(v, true); t.value='';
}
$('#send').addEventListener('click', sendText);
$('#text').addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }
});
$('#btnReset').addEventListener('click', resetAll);
</script>
</body>
</html>